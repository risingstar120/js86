<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ROP Interactive</title>
    <script src="anime.min.js"></script>
    <script src="capstone-x86.min.js"></script>
    <link rel="stylesheet" href="rop-interactive.css" />
</head>
<body>
    <script>
        var cpu = undefined;
    </script>

    <script type="module">
        import {CPU} from './Models/CPU.js';

        (function() {
            var oReq = new XMLHttpRequest();
            oReq.open("GET", "/binaries/first", true);
            oReq.responseType = "arraybuffer";

            oReq.onload = function (oEvent) {
                var arrayBuffer = oReq.response; // Note: not oReq.responseText
                if (arrayBuffer) {
                    var byteArray = new Uint8Array(arrayBuffer);

                    let hexDump = "";
                    byteArray.forEach((byte) => {
                        hexDump += byte.toString(16).padStart(2, "0") + " ";
                    });

                    console.log("Loading code: ");
                    console.log(hexDump);

                    cpu = new CPU(0x256);
                    cpu.loadCode(byteArray);

                    console.log("Loaded CPU. Disassembly: \n" + cpu.fullDisassembledCode().join("\n"));

                    while(!cpu.done) {
                        cpu.nextInstruction();
                    }
                }
            };

            oReq.send(null);
        })();
    </script>

    <div id="box">

    </div>
</body>
</html>